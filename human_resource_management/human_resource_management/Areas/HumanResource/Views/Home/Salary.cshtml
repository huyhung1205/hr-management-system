
@using Newtonsoft.Json;

@model dynamic
@*
    MÔ TẢ VIEW: QUẢN LÝ TÍNH LƯƠNG
    -------------------------------------------------
    View này xử lý toàn bộ quy trình tính lương cho nhân viên theo tháng:
    1. Chọn kỳ lương (Tháng/Năm).
    2. Hiển thị danh sách nhân viên cần tính lương (nếu chưa tính).
    3. Nút "Tính toán" để kích hoạt logic tính lương tự động.
    4. Hiển thị bảng chi tiết lương sau khi tính toán xong.
*@

@{
    ViewBag.Title = "Quản lý lương";
    Layout = "~/Areas/HumanResource/Views/Shared/_Layout.cshtml";
}

<div class="space-y-6">
    <!-- KHỐI 1: BỘ LỌC KỲ LƯƠNG -->
    <!-- Cho phép người dùng chọn Tháng và Năm làm việc -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">
            <i class="fa-solid fa-calculator text-blue-600 mr-2"></i>
            Chọn Kỳ Lương
        </h3>

        <form method="get" action="@Url.Action("Salary", "Home", new { area = "HumanResource" })" class="space-y-4" id="salaryForm">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Lựa chọn Tháng -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-calendar text-gray-500 mr-1"></i>
                        Tháng <span class="text-red-500">*</span>
                    </label>
                    <select name="thang" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required onchange="document.getElementById('salaryForm').submit();">
                        @for (int i = 1; i <= 12; i++)
                        {
                            <option value="@i" @(i == ViewBag.SelectedThang ? "selected" : "")>Tháng @i</option>
                        }
                    </select>
                </div>

                <!-- Dropdown chọn Năm: Từ năm hiện tại -2 đến +1 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fa-solid fa-calendar-days text-gray-500 mr-1"></i>
                        Năm <span class="text-red-500">*</span>
                    </label>
                    <select name="nam" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required onchange="document.getElementById('salaryForm').submit();">
                        @for (int i = DateTime.Now.Year - 2; i <= DateTime.Now.Year + 1; i++)
                        {
                            <option value="@i" @(i == ViewBag.SelectedNam ? "selected" : "")>@i</option>
                        }
                    </select>
                </div>

                <!-- Nút Tính Lương -->
                <div class="flex items-end">
                    @{
                        bool hasEmployeeData = ViewBag.EmployeeSalaryData != null && ViewBag.EmployeeSalaryData.Count > 0;
                    }
                    @if (hasEmployeeData)
                    {
                        <button type="button" onclick="document.getElementById('calculateSalaryForm').submit();" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-sm">
                            <i class="fa-solid fa-calculator"></i>
                            Tính Lương
                        </button>
                    }
                </div>
            </div>
        </form>
    </div>

    <!-- Hidden form for salary calculation -->
    <form method="post" action="@Url.Action("SaveCalculateSalary", "Home", new { area = "HumanResource" })" id="calculateSalaryForm" style="display:none;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="thang" value="@ViewBag.SelectedThang" />
        <input type="hidden" name="nam" value="@ViewBag.SelectedNam" />
    </form>

    <!-- Thông báo (nổi góc phải) -->
    @if (ViewBag.ErrorMessage != null)
    {
        <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow-lg">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-circle-exclamation text-red-600 text-xl mt-1"></i>
                    <div>
                        <p class="text-sm font-medium text-red-800">Lỗi</p>
                        <p class="text-sm text-red-700 mt-1">@ViewBag.ErrorMessage</p>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-lg">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-circle-check text-green-600 text-xl mt-1"></i>
                    <div>
                        <p class="text-sm font-medium text-green-800">Thành công</p>
                        <p class="text-sm text-green-700 mt-1">@TempData["SuccessMessage"]</p>
                    </div>
                </div>
            </div>
        </div>
        TempData.Remove("SuccessMessage");
    }

    @if (ViewBag.ErrorList != null && ViewBag.ErrorList.Count > 0)
    {
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-sm">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-info-circle text-blue-600 text-xl mt-1"></i>
                <div>
                    <p class="text-sm font-medium text-blue-800">Chưa có dữ liệu công của tháng này</p>
                </div>
            </div>
        </div>
    }

    <!-- DEBUG: Check data -->
    @{
        var empData = ViewBag.EmployeeSalaryData;
        var salaryDetails = ViewBag.SalaryDetails;
    }
    <div style="display:none;">
        EmployeeSalaryData type: @(empData?.GetType().Name ?? "null") | Count: @(empData?.Count ?? 0)
        SalaryDetails type: @(salaryDetails?.GetType().Name ?? "null") | Count: @(salaryDetails?.Count ?? 0)
    </div>

    <!-- KHỐI 2: TRƯỜNG HỢP CHƯA CÓ BẢNG LƯƠNG -->
    <!-- Hiển thị danh sách nhân viên sẵn sàng để tính lương. Dữ liệu này giúp HR kiểm tra trước khi bấm tính -->
    @if (ViewBag.EmployeeSalaryData != null && ViewBag.EmployeeSalaryData.Count > 0)
    {
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fa-solid fa-users text-green-600 mr-2"></i>
                    Danh Sách Nhân Viên - Tháng @ViewBag.SelectedThang/@ViewBag.SelectedNam
                </h3>
                <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-semibold">
                    Chưa tính lương
                </span>
            </div>

            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Mã NV</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Họ Tên</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Chức Vụ</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Lương Cơ Bản</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-700">Ngày Công</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @foreach (var emp in ViewBag.EmployeeSalaryData)
                        {
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 text-gray-600 font-medium">@emp.maNV</td>
                                <td class="px-4 py-3 font-medium text-gray-800">@emp.hoTen</td>
                                <td class="px-4 py-3 text-gray-600">@emp.chucVu</td>
                                <td class="px-4 py-3 text-right text-gray-600">@emp.luongCoBan.ToString("N0") đ</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium">
                                        @emp.ngayCong ngày
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                <i class="fa-solid fa-info-circle mr-2"></i>
                <strong>Tổng cộng:</strong> @ViewBag.EmployeeSalaryData.Count nhân viên sẵn sàng tính lương
            </div>
        </div>
    }

    <!-- KHỐI 3: TRƯỜNG HỢP ĐÃ TÍNH LƯƠNG XONG -->
    <!-- Hiển thị chi tiết bảng lương đã được lưu trong database. Cho phép xem, sửa hoặc xóa lại để tính lại -->
    @if (ViewBag.SalaryDetails != null && ViewBag.SalaryDetails.Count > 0)
    {
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fa-solid fa-file-invoice-dollar text-blue-600 mr-2"></i>
                    Chi Tiết Bảng Lương - Tháng @ViewBag.Thang/@ViewBag.Nam
                </h3>
                <span class="inline-block px-3 py-1 rounded text-xs font-semibold @(ViewBag.TrangThai ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800")">
                    @if (ViewBag.TrangThai)
                    {
                        <i class="fa-solid fa-check-circle mr-1"></i>
                        <text>Đã thanh toán</text>
                    }
                    else
                    {
                        <i class="fa-solid fa-clock mr-1"></i>
                        <text>Chưa thanh toán</text>
                    }
                </span>
            </div>

            <!-- Thông tin bảng lương -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg mb-4">
                <div>
                    <p class="text-xs text-gray-600">Người Tạo</p>
                    <p class="font-semibold text-gray-800">@ViewBag.NguoiTao</p>
                </div>
                <div>
                    <p class="text-xs text-gray-600">Ngày Tạo</p>
                    <p class="font-semibold text-gray-800">@(ViewBag.NgayTao != null ? ViewBag.NgayTao.ToString("dd/MM/yyyy HH:mm") : "")</p>
                </div>
                <div>
                    <p class="text-xs text-gray-600">Số Nhân Viên</p>
                    <p class="font-semibold text-gray-800">@ViewBag.SalaryDetails.Count</p>
                </div>
                <div>
                    <p class="text-xs text-gray-600">Tổng Lương</p>
                    <p class="font-semibold text-green-600 text-lg">@ViewBag.TotalSalary.ToString("N0") đ</p>
                </div>
            </div>

            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Mã NV</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Họ Tên</th>
                            <th class="px-4 py-3 text-left font-semibold text-gray-700">Chức Vụ</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Lương Cơ Bản</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-700">Ngày Công</th>
                            <th class="px-4 py-3 text-right font-semibold text-gray-700">Lương Thực Nhận</th>
                            <th class="px-4 py-3 text-center font-semibold text-gray-700">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @foreach (var detail in ViewBag.SalaryDetails)
                        {
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 text-gray-600 font-medium">@detail.maNV</td>
                                <td class="px-4 py-3 font-medium text-gray-800">@detail.hoTen</td>
                                <td class="px-4 py-3 text-gray-600">@detail.chucVu</td>
                                <td class="px-4 py-3 text-right text-gray-600">@detail.BaseSalary.ToString("N0") đ</td>
                                <td class="px-4 py-3 text-center text-gray-600">@detail.ngayCong ngày</td>
                                <td class="px-4 py-3 text-right font-semibold text-green-700">@detail.luongThucNhan.ToString("N0") đ</td>
                                <td class="px-4 py-3 text-center">
                                    <button type="button" 
                                        class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-xs font-medium transition-colors"
                                        onclick="editSalary(@detail.maChiTiet, '@detail.maNV', @detail.luongThucNhan)">
                                        <i class="fa-solid fa-edit mr-1"></i>
                                        Sửa
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Hành động xóa -->
            <button type="button" 
                onclick="deleteSalary(@ViewBag.SalaryMonthId, @ViewBag.Thang, @ViewBag.Nam)"
                class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
                <i class="fa-solid fa-trash"></i>
                Xóa Bảng Lương
            </button>
        </div>
    }

    <!-- KHỐI 4: GHI CHÚ QUY TẮC TÍNH TOÁN -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="font-semibold text-blue-900 mb-2">
            <i class="fa-solid fa-book text-blue-600 mr-2"></i>
            Công Thức Tính Lương
        </h4>
        <ul class="text-sm text-blue-800 space-y-1">
            <li><strong>Lương cơ bản:</strong> Được lấy từ hợp đồng hiện hành</li>
            <li><strong>Lương thực nhận:</strong> Lương cơ bản × (Ngày công / 26)</li>
            <li><strong>Ngày công:</strong> Số ngày chấm công trong tháng</li>
        </ul>
    </div>
</div>

<script>
// ===== DEBUG INFO =====
console.log('=== SALARY PAGE DEBUG INFO ===');
console.log('Selected Month:', @ViewBag.SelectedThang);
console.log('Selected Year:', @ViewBag.SelectedNam);

@if (ViewBag.SalaryDetails != null && ViewBag.SalaryDetails.Count > 0)
{
    <text>
console.log('✓ HAS SALARY (SalaryDetails)');
console.log('SalaryDetails Count:', @ViewBag.SalaryDetails.Count);
console.log('SalaryDetails:', @Html.Raw(JsonConvert.SerializeObject(ViewBag.SalaryDetails)));
    </text>
}
else
{
    <text>
console.log('✗ NO SALARY (SalaryDetails empty)');
    </text>
}

@if (ViewBag.EmployeeSalaryData != null && ViewBag.EmployeeSalaryData.Count > 0)
{
    <text>
console.log('✓ HAS EMPLOYEE DATA');
console.log('EmployeeSalaryData Count:', @ViewBag.EmployeeSalaryData.Count);
console.log('EmployeeSalaryData:', @Html.Raw(JsonConvert.SerializeObject(ViewBag.EmployeeSalaryData)));
    </text>
}
else
{
    <text>
console.log('✗ NO EMPLOYEE DATA (Empty)');
    </text>
}

@if (ViewBag.ErrorMessage != null)
{
    <text>
console.error('ERROR MESSAGE:', '@ViewBag.ErrorMessage');
    </text>
}

@if (ViewBag.ErrorList != null && ViewBag.ErrorList.Count > 0)
{
    <text>
console.warn('ERROR LIST:', @Html.Raw(JsonConvert.SerializeObject(ViewBag.ErrorList)));
    </text>
}

console.log('=== END DEBUG ===');
</script>

<script>
function editSalary(salaryDetailId, maNV, currentSalary) {
    alert('Chức năng chỉnh sửa lương cho ' + maNV + ' sẽ được cập nhật sau');
}

function deleteSalary(salaryMonthId, thang, nam) {
    if (confirm('Bạn chắc chắn muốn xóa bảng lương tháng ' + thang + '/' + nam + '? Hành động này không thể hoàn tác!')) {
        window.location.href = '@Url.Action("DeleteSalary", "Home", new { area = "HumanResource" })' + '?id=' + salaryMonthId;
    }
}
</script>



