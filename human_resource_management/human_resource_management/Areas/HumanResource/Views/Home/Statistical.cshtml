﻿@model IEnumerable<human_resource_management.Models.PhongBan>
@*
    MÔ TẢ VIEW: THỐNG KÊ NHÂN SỰ
    -------------------------------------------------
    View này hiển thị báo cáo tổng quan về nhân sự theo phòng ban.
    - Sử dụng: Google Charts API để vẽ biểu đồ tròn (Pie Chart).
    - Hiển thị bảng số liệu chi tiết bên trái và biểu đồ trực quan bên phải.
*@

@{
    ViewBag.Title = "Thống kê nhân sự";
    Layout = "~/Areas/HumanResource/Views/Shared/_Layout.cshtml";

    // CHUẨN BỊ DỮ LIỆU CHO BIỂU ĐỒ (Server-side)
    // Chuyển đổi dữ liệu Model (Entity) sang dạng mảng JSON đơn giản để JS có thể đọc được
    // Cấu trúc: [Tên Phòng, Số Lượng]
    var chartData = Model.Select(pb => new object[]
    {
        pb.tenPB,
        pb.NhanViens?.Count ?? 0 // Sử dụng toán tử null-coalescing (??) để tránh lỗi null
    }).ToList();
}

<style>
    div.google-visualization-tooltip {
        pointer-events: none !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #e5e7eb !important;
    }
</style>

<div class="w-full">
    <div class="mb-6 text-center">
        <h2 class="text-2xl font-bold text-gray-800 uppercase">Thống kê số lượng nhân viên</h2>
        <div class="h-1 w-20 bg-blue-500 mx-auto mt-2 rounded"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div class="bg-white rounded-lg shadow-md border border-gray-200">
            <div class="bg-blue-600 px-4 py-3 border-b border-gray-200 rounded-t-lg">
                <h3 class="text-white font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-table"></i> Chi tiết số liệu
                </h3>
            </div>

            <div class="p-0 overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm uppercase leading-normal">
                            <th class="py-3 px-6 border-b">Tên Phòng Ban</th>
                            <th class="py-3 px-6 border-b text-center">Số Lượng NV</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                // Logic đếm gọn gàng
                                var count = item.NhanViens?.Count ?? 0;

                                <tr class="border-b border-gray-200 hover:bg-gray-100 transition-colors">
                                    <td class="py-3 px-6 font-medium whitespace-nowrap">@item.tenPB</td>
                                    <td class="py-3 px-6 text-center">
                                        <span class="bg-blue-100 text-blue-800 py-1 px-3 rounded-full text-xs font-bold">
                                            @count
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" class="py-4 text-center text-gray-400 italic">Chưa có dữ liệu</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md border border-gray-200">
            <div class="bg-green-600 px-4 py-3 border-b border-gray-200 rounded-t-lg">
                <h3 class="text-white font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie"></i> Biểu đồ tỷ lệ
                </h3>
            </div>
            <div class="p-4 flex justify-center items-center bg-white rounded-b-lg">
                <div id="piechart" class="w-full" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- TÍCH HỢP GOOGLE CHARTS -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    // Load thư viện visualcore
    google.charts.load("current", { packages: ["corechart"] });
    // Gọi hàm vẽ biểu đồ sau khi thư viện tải xong
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        // 1. Nhận dữ liệu từ Server (đã encode JSON)
        var serverData = @Html.Raw(Json.Encode(chartData));

        // 2. Định nghĩa Header của dữ liệu (Yêu cầu của Google Charts)
        var chartDataArray = [['Phòng Ban', 'Số Lượng']];

        // 3. Gộp Header và Dữ liệu
        chartDataArray = chartDataArray.concat(serverData);

        // 4. Chuyển đổi sang định dạng DataTable chuyên dụng
        var data = google.visualization.arrayToDataTable(chartDataArray);

        // 5. Cấu hình giao diện biểu đồ
        var options = {
            title: 'Tỷ lệ phân bố nhân sự',
            is3D: false,
            pieHole: 0.4, // Tạo biểu đồ dạng Donut
            tooltip: { isHtml: true },
            chartArea: { left: '10%', top: '10%', width: '80%', height: '80%' },
            titleTextStyle: { fontSize: 16, bold: true, color: '#374151' },
            legend: { position: 'right', alignment: 'center', textStyle: { fontSize: 13 } },
            // Bảng màu tùy chỉnh đẹp mắt hơn màu mặc định
            colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1']
        };

        // 6. Vẽ biểu đồ lên thẻ div #piechart
        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
    }

    // Tự động vẽ lại biểu đồ khi thay đổi kích thước cửa sổ (Responsive)
    window.onresize = drawChart;
</script>